<!DOCTYPE html>
<html>

<head>
    <meta name="Description" content="Notes written by Corey Trager in HTML and Javascript">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Notes</title>

    <style>
        body {
            font-family: verdana, arial;
            font-size: 20px;
            margin: 20px;
        }

        button {
            font-family: verdana, arial;
            font-size: 20px;
            white-space: nowrap;
        }

        #gain_input {
            font-size: 20px;
        }

        #duration {
            font-size: 20px;
        }

        #my_title {
            font-size: 18px;
            letter-spacing: 3px;
        }

        .not_pressed {
            color: black;
            font-weight: normal;
        }

        .pressed {
            color: red;
            font-weight: bold
        }

        .footer {
            font-size: 12px;
        }
    </style>
    <script>
        "use strict"

        var AudioContext = window.AudioContext || window.webkitAudioContext; // cross browser    
        var audio_context
        var oscillator
        var gain
        var gain_factor = .5
        var gain_input
        var prev_frequency
        var prev_button
        var note_array
        var note_index
        var timeout = null
        var notes_textarea
        var name_to_freq_hash = {

            "c3": 130.81,
            "c#3": 138.59,
            "db3": 138.59,
            "d3": 146.83,
            "d#3": 155.56,
            "eb3": 155.56,
            "e3": 164.81,
            "f3": 174.61,
            "f#3": 185.00,
            "gb3": 185.00,
            "g3": 196.00,
            "g#3": 207.65,
            "ab3": 207.65,
            "a3": 220.00,
            "a#3": 233.08,
            "bb3": 233.08,
            "b3": 246.94,

            "c4": 261.63,
            "c#4": 277.18,
            "db4": 277.18,
            "d4": 293.66,
            "d#4": 311.13,
            "eb4": 311.13,
            "e4": 329.63,
            "f4": 349.23,
            "f#4": 369.23,
            "gb4": 369.23,
            "g4": 392.00,
            "g#4": 415.30,
            "ab4": 415.30,
            "a4": 440,
            "a#4": 466.16,
            "bb4": 466.16,
            "b4": 493.88,

            "c5": 523.25
        }


        function on_load() {
            gain_input = document.getElementById("gain_input")
            notes_textarea = document.getElementById("notes_textarea");
            notes_textarea.value = snippets["kreutzer"]
        }

        function change_gain() {
            gain_factor = gain_input.value / 100.0
            gain.gain.value = gain_factor
        }

        function play_or_stop() {
            if (my_play_button.innerText == "Start") {
                play()
            } else {
                stop_playing()
            }
        }

        function play(frequency, button) {

            my_play_button.innerText = "Stop"
            my_play_button.style.backgroundColor = "red"

            // can't do this in onload because browser wants an explicit user gesture
            if (audio_context == null) {
                audio_context = new AudioContext()

                // There's a "node graph"  oscillator->gain->destination
                oscillator = audio_context.createOscillator()
                gain = audio_context.createGain()
                gain.gain.value = gain_factor
                oscillator.connect(gain)
                oscillator.start()
            }


            var notes = notes_textarea.value
            notes = notes.replace(/ /g, ""); // remove spaces
            notes = notes.replace(/\n/g, "");
            note_array = notes.split(",")
            note_index = 0

            next_note()

        }

        function next_note() {


            console.log(note_array[note_index])

            var frequency = name_to_freq_hash[note_array[note_index]]

            if (typeof frequency == 'undefined') {
                play_or_stop();
                alert("Oops! " + note_array[note_index])
                return
            }

            oscillator.frequency.value = frequency

            // connect and disconnect is on and off
            gain.connect(audio_context.destination)


            if (note_index < (note_array.length - 1)) {
                note_index++

            }
            else {
                note_index = 0
            }

            timeout = setTimeout(next_note, document.getElementById("duration").value)


        }

        function stop_playing() {
            try {
                clearTimeout(timeout)
                gain.disconnect()
                //prev_button.className = "not_pressed"
            } catch (err) {
                // swallow
            }
            my_play_button.innerText = "Start"
            my_play_button.style.backgroundColor = "lightgreen"

        }

        function back() {
            note_index -= document.getElementById("number_back").value
            if (note_index < 0) {
                note_index = 0
            }

        }

        var kreutzer_notes = `c4,e4,g4,f4,e4,f4,d4,e4,
c4,e4,g4,f4,e4,f4,d4,e4,
        
c4,e4,g4,f4,e4,f4,d4,e4,
c4,d4,e4,d4,c4,d4,b3,c4,
        
a3,c4,e4,d4,c4,d4,b3,c4,
a3,c4,e4,d4,c4,d4,b3,c4,
    
a3,c4,e4,d4,c4,d4,b3,c4,
a3,b3,c4,b3,a3,b3,g3,a3,
       
f3,a3,c4,a#3,a3,a#3,g3,a3,
f3,a3,d4,c4,b3,c4,a3,b3,

g3,b3,d4,c4,b3,c4,a3,b3,
g3,b3,e4,d4,c4,d4,b3,c4,

a3,c4,e4,d4,c4,d4,b3,c4,
a3,c4,f4,e4,d4,e4,c4,d4,

b3,d4,f4,e4,d4,e4,c4,d4,
b3,d4,g4,f4,e4,f4,d4,e4,

c4,c4
`
        var arpeggios_notes = `c4,eb4,g4,c5,g4,eb4,
c4,e4,g4,c5,g4,e4,
c4,e4,a4,c5,a4,e4,
c4,f4,a4,c5,a4,f4,
c4,f4,ab4,c5,ab4,f4,
c4,eb4,f#4,a4,c5,a4,f#4,eb4,
c4,e4,g4,bb4,c5,bb4,g4,e4,f4,f4
`
        var scale_notes = 'c3,d3,e3,f3,g3,a3,b3,c4,b3,a3,g3,f3,e3,d3,c3'


        var snippets = {

            "kreutzer": kreutzer_notes,
            "arpeggios": arpeggios_notes,
            "scale": scale_notes

        }

        function select_excercise() {
            var el = document.getElementById("excercise")
            var index = el.selectedIndex
            var snippet_key = el.options[index].value
            notes_textarea.value = snippets[snippet_key]
            stop_playing()

        }

    </script>
</head>

<body onload="on_load()">

    Select excercise:
    <br>
    <select onclick="select_excercise()" id="excercise" size="3">
        <option value="kreutzer">Kreutzer 2</option>
        <option value="arpeggios">Arpeggios</option>
        <option value="scale">C scale</option>
    </select><br><br>

    or type notes:
    <br>
    <textarea rows="10" cols="30" id="notes_textarea">

    </textarea>

    <br>
    <br>
    Duration in milliseconds:
    <br>
    <input id="duration" type="number" min="100" max="5000" type="text" value="500"></input>
    <br>
    <br>

    <button id="my_play_button" onclick="play_or_stop()" style="background-color: lightgreen;">Start</button>

    <br>
    <br>
    <button onclick="back()">Go Back</button>
    <input id="number_back" type="number" min="1" max="20" type="text" value="12"></input>

    <br>
    <br>
    Volume:
    <br>
    <input id="gain_input" type="number" onchange="change_gain()" min="1" max="100" value="50"></input>
    <br>
    <br>

    <div class="footer">by <a href="https://ctrager.github.io">Corey Trager</a> - <a
            href="https://github.com/ctrager/notes">https://github.com/ctrager/notes</a></div>

</body>

</html>